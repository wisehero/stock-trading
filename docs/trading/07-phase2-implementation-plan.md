# 2차 구현 계획 (정정주문/TIF/만료/수수료)

## 기준 문서
- `06-phase2-requirement-lock.md`
- 확정값: `Q1-1`, `Q2-1`, `Q3-1`, `Q4-3`

## 목표
- 정정주문(가격 변경 + 잔량 감소) 지원
- 지정가 `DAY/IOC/FOK`, 시장가 `IOC` 규칙 구현
- 장 종료 배치 기반 `DAY` 만료(`EXPIRED`) 처리
- 수수료 체결 단위 계산 + 세금 0 정책 반영

## 범위
- 포함
  - 도메인: `Tif` 추가, 정정 규칙 추가, 만료 전이 추가
  - 서비스: 정정/체결/취소/만료 흐름 확장
  - API: 정정 주문 API, 장 종료 배치 트리거
  - 테스트: 단위/통합 테스트 확장
- 제외
  - 외부 거래소 연동
  - 시간외/예약 주문
  - 세금 계산(2차는 고정 0)

## 상세 작업

### 1) 도메인/스키마 확장
- `Order` 엔티티에 `tif` 필드 추가
- `Order` 도메인 메서드 추가
  - `amendLimitPrice(...)`
  - `amendRemainingQuantity(...)` (감소만 허용)
  - `markExpired()`
- 필요 시 `orders` 테이블 컬럼 추가
  - `tif` (`DAY|IOC|FOK`)

### 2) 주문 생성/체결 로직 확장
- 주문 생성 시 정책 검증
  - 시장가: `IOC`만 허용
  - 지정가: `DAY/IOC/FOK` 허용
- 매칭 결과 후처리
  - `IOC`: 미체결 잔량 즉시 취소 + 선점 해제
  - `FOK`: 전량 체결 불가 시 전량 취소 + 선점 해제
  - `DAY`: 잔량 유지

### 3) 정정주문 구현
- API: `PATCH /api/v1/orders/{orderId}`
- 정정 검증 규칙
  - 상태: `NEW`, `PARTIALLY_FILLED`만 허용
  - 시장가 주문 정정 불가
  - 수량은 기존 잔량보다 작은 값만 허용
- 정정 시 선점 재계산
  - 수량 감소분에 대한 선점 즉시 해제
  - 가격 변경 시 매수 선점금 부족/초과 재검증

### 4) DAY 만료 배치 구현
- 스케줄러(장 종료 시각)에서 대상 주문 조회
  - `tif=DAY` + `NEW/PARTIALLY_FILLED`
- 만료 처리
  - 상태 `EXPIRED`
  - 잔여 선점 해제
- 운영 편의용 수동 트리거 API 추가 고려
  - 예: `POST /api/v1/admin/orders/expire-day`

### 5) 수수료/세금 정책 반영
- 체결 단위 수수료 계산
  - `fee = fillNotional * feeRate`
  - scale 4, `HALF_UP`
- 세금은 0 고정
- 설정
  - `trading.fee-rate`
  - `trading.tax-rate=0`

## 테스트 계획
- 도메인 단위 테스트
  - 정정 가능/불가 조건
  - IOC/FOK 전이 규칙
  - DAY 만료 전이
- 서비스 통합 테스트
  - IOC 부분체결 후 잔량 취소
  - FOK 전량 미체결 시 전체 취소
  - 정정 후 선점 재계산
  - 장 종료 배치 만료 + 선점 해제
- 회귀 테스트
  - 기존 1차 주문/취소/부분체결 시나리오 유지 확인

## 완료 기준
- 정책 위반 입력이 모두 명시적 에러 코드로 응답
- `./gradlew test` 통과
- 문서/주석/PR 설명 한글 기준 유지
