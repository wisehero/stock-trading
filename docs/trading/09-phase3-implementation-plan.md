# 3차 구현 계획 (상태/이벤트/장애대응)

## 기준 문서
- `08-phase3-requirement-lock.md`
- 확정값: `Q1-1`, `Q2-1`, `Q3-1`, `Q4-1`, `Q5-1`, `Q6-1`

## 목표
- DB 단일 진실원 기준의 이벤트 처리 정합성 강화
- 중복/역순 이벤트 안전 처리
- 실패 재시도 + 오류 적재 체계 도입
- 대사 실패 상태 관리 및 수동 재처리 운영 API 제공

## 범위
- 포함
  - 이벤트 처리 멱등키/버전 체크
  - 실패 재시도(3회 지수 백오프)
  - 오류 테이블 적재
  - `RECONCILIATION_FAILED` 상태와 운영 API
  - 사용자 노출 상태 6종 고정
- 제외
  - 이벤트 소싱 전환
  - 외부 브로커 연동
  - 자동 대사 보정 고도화

## 상세 작업

### 1) 도메인/모델 확장
- 주문 도메인 상태 확장
  - `RECONCILIATION_FAILED` 추가 여부 검토 및 반영
- 이벤트 처리 로그 엔티티 추가
  - 예: `order_event_logs`
  - 필드: `event_id`, `order_id`, `event_type`, `payload`, `processed_at`, `result`
- 오류 적재 엔티티 추가
  - 예: `order_event_failures`
  - 필드: `event_id`, `order_id`, `attempt_count`, `last_error`, `failed_at`

### 2) 이벤트 멱등/역순 방어
- 멱등 규칙
  - `executionId` 중복 체결 저장 차단
  - 처리 완료 이벤트 재수신 시 무시
- 역순 방어
  - 주문 버전 기반 비교 후 오래된 이벤트 무시
  - 무시 이벤트는 로그에 `SKIPPED_OUTDATED`로 기록

### 3) 재시도 및 타임아웃
- 처리 타임아웃 3초 적용
- 실패 시 재시도
  - 최대 3회
  - 지수 백오프(예: 200ms, 400ms, 800ms)
- 최종 실패
  - 주문 상태 `REJECTED`
  - 에러 코드 기록
  - `order_event_failures` 적재

### 4) 대사 실패 운영 절차
- 대사 실패 상태
  - `RECONCILIATION_FAILED` 표기
- 운영 API
  - 대사 실패 목록 조회
  - 수동 재처리 실행
- 감사 로그
  - 재처리 수행자/시간/결과 기록

### 5) API 계약 정리
- 사용자 노출 상태를 6종으로 고정
  - `NEW`, `PARTIALLY_FILLED`, `FILLED`, `CANCELED`, `REJECTED`, `EXPIRED`
- 내부 중간 상태는 외부 응답에서 비노출

## 테스트 계획
- 단위 테스트
  - 멱등 처리(중복 `executionId`)
  - 역순 이벤트 무시
  - 타임아웃 및 재시도 카운트
- 통합 테스트
  - 3회 실패 후 `REJECTED` 전이 + 오류 적재
  - 대사 실패건 수동 재처리 성공/실패
  - 사용자 상태 노출 6종 검증
- 회귀 테스트
  - 1차/2차 주문 생성/취소/정정/만료 흐름 정상 동작 확인

## 완료 기준
- 중복/역순 이벤트에도 상태 정합성 유지
- 실패 이벤트가 유실 없이 오류 테이블에 적재
- 수동 재처리 API로 실패건 복구 가능
- `./gradlew test` 통과
