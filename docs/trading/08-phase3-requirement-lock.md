# 3차 요구사항 확정 문서

## 목적
- 2차까지 구현된 주문/체결 흐름 위에 운영 안정성과 상태 정합성 규칙을 확정한다.
- 3차는 아래 3개 축을 고정한 뒤 구현으로 진입한다.
  - 상태/이벤트 처리 기준
  - 장애 대응(재시도/타임아웃/보상)
  - 운영 절차(대사/수동 개입)

## 전제
- 현재 시스템은 단일 DB + 내부 모의 거래소 구조를 유지한다.
- 상태의 1차 저장소는 DB(`orders`, `fills`, `order_holds`)이다.
- 3차에서도 API 표준 응답과 한글 문서/주석 기준을 유지한다.

## 확정 메타
- 확정일: 2026-02-18
- 확정 선택: `Q1-1`, `Q2-1`, `Q3-1`, `Q4-1`, `Q5-1`, `Q6-1`

## 현재까지 확정 요약
- 주문 정책: 지정가 `DAY/IOC/FOK`, 시장가 `IOC`
- 정정 정책: 지정가 주문, 잔량 감소만 허용
- DAY 만료: `15:40` 배치(Asia/Seoul)
- 금액 정책: 수수료 적용, 세금 0
- 수량 정책: 1주 단위

## 3차 정책 확정안

### 1) 상태 전이 소스 오브 트루스
- DB 상태를 단일 진실원으로 사용한다.
- 이벤트는 파생 로그(감사/추적 용도)로 저장한다.

### 2) 이벤트 중복/역순 처리
- `executionId` 기반 멱등 처리 적용
- 주문 버전 검사로 역순 이벤트는 무시

### 3) 이벤트 처리 실패 재시도
- 최대 3회 지수 백오프 재시도
- 최종 실패건은 오류 테이블에 적재

### 4) 타임아웃/보상 트랜잭션
- 체결 처리 타임아웃 기준은 3초
- 실패 시 주문 상태 원복 대신 `REJECTED` + 에러코드 기록

### 5) 정산 대사 실패 운영 절차
- 실패건은 `RECONCILIATION_FAILED` 상태로 표기
- 수동 재처리 API를 제공한다.

### 6) 사용자 노출 주문 상태 집합
- 노출 상태는 아래 6개로 고정한다.
  - `NEW`
  - `PARTIALLY_FILLED`
  - `FILLED`
  - `CANCELED`
  - `REJECTED`
  - `EXPIRED`

## 선택지 확정 결과
- Q1-1: DB 단일 진실원 + 이벤트 파생 로그
- Q2-1: `executionId` 멱등 + 버전 검사
- Q3-1: 3회 지수 백오프 + 오류 테이블 적재
- Q4-1: 3초 타임아웃 + `REJECTED` 기록
- Q5-1: `RECONCILIATION_FAILED` 표기 + 수동 재처리 API
- Q6-1: 사용자 노출 상태 6종 고정

## 구현 진입 조건
- 아래 순서로 3차 구현 진행
  1. 이벤트 처리/멱등/버전 정책 코드 반영
  2. 실패 재시도 및 오류 적재 구조 반영
  3. 대사 실패 운영 API/관리 포인트 추가
  4. 상태 노출 계약(API) 정리
  5. 통합 테스트(중복/역순/실패/복구) 추가
