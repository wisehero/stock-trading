# 3차 요구사항 확정 문서 (초안)

## 목적
- 2차까지 구현된 주문/체결 흐름 위에 운영 안정성과 상태 정합성 규칙을 확정한다.
- 3차는 아래 3개 축을 고정한 뒤 구현으로 진입한다.
  - 상태/이벤트 처리 기준
  - 장애 대응(재시도/타임아웃/보상)
  - 운영 절차(대사/수동 개입)

## 전제
- 현재 시스템은 단일 DB + 내부 모의 거래소 구조를 유지한다.
- 상태의 1차 저장소는 DB(`orders`, `fills`, `order_holds`)이다.
- 3차에서도 API 표준 응답과 한글 문서/주석 기준을 유지한다.

## 현재까지 확정 요약
- 주문 정책: 지정가 `DAY/IOC/FOK`, 시장가 `IOC`
- 정정 정책: 지정가 주문, 잔량 감소만 허용
- DAY 만료: `15:40` 배치(Asia/Seoul)
- 금액 정책: 수수료 적용, 세금 0
- 수량 정책: 1주 단위

## 3차 확정 필요 항목(역질문)

### Q1. 상태 전이 소스 오브 트루스
- 선택지 1 (권장): DB 상태를 단일 진실원으로 사용 + 이벤트는 파생 로그
- 선택지 2: 이벤트 스트림을 단일 진실원으로 사용(이벤트 소싱)
- 선택지 3: DB/이벤트 이중 진실원 허용(운영 복잡도 증가)

### Q2. 이벤트 중복/역순 처리 정책
- 선택지 1 (권장): `executionId` 멱등 + 주문 버전 검사로 역순 이벤트 무시
- 선택지 2: 이벤트 도착 순서 그대로 반영(단순하지만 정합성 위험)
- 선택지 3: 역순 이벤트 보관 후 재정렬 처리(구현 복잡)

### Q3. 이벤트 처리 실패 시 재시도
- 선택지 1 (권장): 최대 3회 지수 백오프 후 DLQ(또는 오류 테이블) 적재
- 선택지 2: 무제한 재시도
- 선택지 3: 재시도 없이 즉시 실패 처리

### Q4. 타임아웃/보상 트랜잭션 기준
- 선택지 1 (권장): 체결 처리 3초 타임아웃, 실패 시 주문 상태 원복 대신 `REJECTED`/에러코드 기록
- 선택지 2: 타임아웃 시 자동 재시도만 수행(상태 유지)
- 선택지 3: 타임아웃 시 주문 즉시 취소 + 선점 즉시 해제

### Q5. 정산 대사 실패 시 운영 절차
- 선택지 1 (권장): 대사 실패건 `RECONCILIATION_FAILED` 상태 표기 + 수동 재처리 API
- 선택지 2: 실패 즉시 자동 보정 시도만 수행
- 선택지 3: 로그만 남기고 별도 상태/운영 절차 없음

### Q6. 사용자 노출 주문 상태 집합
- 선택지 1 (권장): `NEW`, `PARTIALLY_FILLED`, `FILLED`, `CANCELED`, `REJECTED`, `EXPIRED`
- 선택지 2: 내부 상태(`PENDING_NEW`, `PENDING_CANCEL`)까지 모두 노출
- 선택지 3: 단순화 상태(`OPEN`, `DONE`, `CANCELED`)만 노출

## 구현 진입 조건
- Q1~Q6 확정 후 아래 순서로 3차 구현 진행
  1. 이벤트 처리/멱등/버전 정책 코드 반영
  2. 실패 재시도 및 오류 적재 구조 반영
  3. 대사 실패 운영 API/관리 포인트 추가
  4. 상태 노출 계약(API) 정리
  5. 통합 테스트(중복/역순/실패/복구) 추가
