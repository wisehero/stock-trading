# 2차 요구사항 확정 문서

## 목적
- 1차(주문/체결/부분체결/취소) 구현 위에 2차 기능 범위를 고정한다.
- 아래 3개 축을 확정한 뒤 구현으로 진입한다.
  - 정정주문 허용 범위
  - 주문 유효시간(TIF: DAY/IOC/FOK)
  - 수수료/세금 계산 규칙

## 확정 메타
- 확정일: 2026-02-15
- 확정 선택: `Q1-1`, `Q2-1`, `Q3-1`, `Q4-3`

## 전제
- 체결 주체는 내부 모의 거래소 엔진을 유지한다.
- 2차에서도 `ResponseEntity`는 사용하지 않고 기존 표준 API 응답을 유지한다.
- 금액/수량 계산은 `BigDecimal`을 사용한다.

## 2차 정책 확정안

### 1) 정정주문(Amend)
- 허용 상태: `NEW`, `PARTIALLY_FILLED`
- 정정 가능 필드:
  - 지정가 주문: `limitPrice` 변경 허용
  - 수량: 미체결 잔량 범위에서 감소만 허용
- 정정 불가 필드: `accountId`, `symbol`, `side`, `orderType`
- 시장가 주문 정정: 미지원(취소 후 재주문)
- 정정 처리 방식: 기존 주문의 잔량에 대해 정책 검증 후 상태/선점 재계산

### 2) TIF(DAY/IOC/FOK)
- 지정가 주문: `DAY`, `IOC`, `FOK` 지원
- 시장가 주문: `IOC`로 고정
- 동작 규칙:
  - `DAY`: 잔량 유지, 만료 시점에 `EXPIRED`
  - `IOC`: 즉시 가능한 수량만 체결 후 잔량 취소
  - `FOK`: 전량 즉시 체결 가능할 때만 체결, 아니면 전량 취소

### 3) DAY 만료 처리
- 장 종료 배치에서 `EXPIRED` 처리
- 배치 대상: `DAY` + `NEW/PARTIALLY_FILLED` 주문
- 처리 결과: 잔량 취소 + 선점 해제 + 상태 `EXPIRED`

### 4) 수수료/세금
- 계산 단위: 체결(`fill`) 단위로 계산 후 주문 단위 합산
- 계산식:
  - 수수료: `fillNotional * feeRate`
- 세금: 2차에서는 미적용(고정 `0`)
- 반올림 정책: 소수점 4자리 `HALF_UP`
- 요율 관리 방식: `application.yml` + 환경변수 오버라이드

## 선택지 확정 결과
- Q1-1: 정정주문 수량은 감소만 허용
- Q2-1: 지정가 `DAY/IOC/FOK`, 시장가 `IOC` 고정
- Q3-1: 장 종료 배치에서 `DAY` 주문 만료 처리
- Q4-3: 수수료만 적용, 세금은 0

## 구현 진입 조건
- 아래 순서로 2차 구현 진행
  1. 도메인 모델 확장(`Tif`, 정정 커맨드, 만료 규칙)
  2. 서비스 로직 확장(정정/IOC/FOK/만료)
  3. API 계약 추가(정정 API, 장 종료 API 또는 배치)
  4. 테스트 추가(단위/통합)
