# 2차 요구사항 확정 문서 (초안)

## 목적
- 1차(주문/체결/부분체결/취소) 구현 위에 2차 기능 범위를 고정한다.
- 아래 3개 축을 확정한 뒤 구현으로 진입한다.
  - 정정주문 허용 범위
  - 주문 유효시간(TIF: DAY/IOC/FOK)
  - 수수료/세금 계산 규칙

## 전제
- 체결 주체는 내부 모의 거래소 엔진을 유지한다.
- 2차에서도 `ResponseEntity`는 사용하지 않고 기존 표준 API 응답을 유지한다.
- 금액/수량 계산은 `BigDecimal`을 사용한다.

## 2차 정책 권장안

### 1) 정정주문(Amend)
- 허용 상태: `NEW`, `PARTIALLY_FILLED`
- 정정 가능 필드:
  - 지정가 주문: `limitPrice` 변경 허용
  - 수량: 미체결 잔량 범위에서 감소만 허용
- 정정 불가 필드: `accountId`, `symbol`, `side`, `orderType`
- 시장가 주문 정정: 미지원(취소 후 재주문)
- 정정 처리 방식: 기존 주문의 잔량에 대해 정책 검증 후 상태/선점 재계산

### 2) TIF(DAY/IOC/FOK)
- 지정가 주문: `DAY`, `IOC`, `FOK` 지원
- 시장가 주문: `IOC`로 고정
- 동작 규칙:
  - `DAY`: 잔량 유지, 만료 시점에 `EXPIRED`
  - `IOC`: 즉시 가능한 수량만 체결 후 잔량 취소
  - `FOK`: 전량 즉시 체결 가능할 때만 체결, 아니면 전량 취소

### 3) 수수료/세금
- 계산 단위: 체결(`fill`) 단위로 계산 후 주문 단위 합산
- 권장 계산식:
  - 수수료: `fillNotional * feeRate`
  - 세금(매도만): `fillNotional * taxRate`
- 반올림 정책(권장): 소수점 4자리 `HALF_UP`
- 요율 관리 방식: `application.yml` + 환경변수 오버라이드

## 확정이 필요한 항목(역질문)

### Q1. 정정주문 수량 정책
- 선택지 1 (권장): 잔량 감소만 허용
- 선택지 2: 잔량 감소/증가 모두 허용(증가 시 선점 재검증 필요)
- 선택지 3: 수량 정정 미지원, 가격 정정만 허용

### Q2. TIF 지원 범위
- 선택지 1 (권장): 지정가 `DAY/IOC/FOK`, 시장가 `IOC` 고정
- 선택지 2: 지정가/시장가 모두 `DAY/IOC/FOK` 허용
- 선택지 3: 2차에서는 `DAY`만 지원

### Q3. DAY 만료 처리 방식
- 선택지 1 (권장): 장 종료 배치에서 `EXPIRED` 처리
- 선택지 2: 장 종료 API 호출 시 즉시 `EXPIRED` 처리
- 선택지 3: 2차에서는 DAY 만료 로직 미구현

### Q4. 수수료/세금 기본 요율
- 선택지 1 (권장): 기본값 0으로 시작하고 운영/테스트 환경에서 설정
- 선택지 2: 고정 기본값 사용(예: 수수료 0.015%, 세금 0.18%)
- 선택지 3: 수수료만 적용하고 세금은 0

## 구현 진입 조건
- 위 Q1~Q4가 확정되면 아래 순서로 2차 구현 진행
  1. 도메인 모델 확장(`Tif`, 정정 커맨드, 만료 규칙)
  2. 서비스 로직 확장(정정/IOC/FOK/만료)
  3. API 계약 추가(정정 API, 장 종료 API 또는 배치)
  4. 테스트 추가(단위/통합)
