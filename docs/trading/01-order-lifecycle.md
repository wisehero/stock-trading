# 주문 라이프사이클 (국내 주식 현물 기준)

## 정책 (1차 릴리즈)
- 100% 현금주문만 지원 (미수/신용 제외)
- 매수는 주문 시점에 필요금액(주문금액 + 수수료 추정치)을 선점
- 매도는 주문 시점에 주문가능수량을 선점
- 체결 주체는 외부 거래소 연동이 아닌 내부 `Mock Exchange Engine`

## 1) 주문 요청
- 사용자가 앱에서 매수/매도 주문을 제출
- 주문 타입(지정가/시장가), 수량, 가격, 계좌를 포함

## 2) 프론트 도메인 검증
- 장 운영 시간, 주문 파라미터, 계좌 상태 1차 검증
- 잘못된 입력은 즉시 실패 처리

## 3) 서버 사전체크(Pre-trade Risk)
- 매수: 주문가능금액(현금) >= 필요금액 검증
- 매도: 주문가능수량 >= 주문수량 검증
- 미수/신용 주문은 1차에서 비허용

## 4) 서버 검증 및 선점(락)
- 매수: 필요금액(주문금액 + 수수료 추정치) 선점
- 매도: 주문수량 선점
- 중복 방지를 위해 멱등키(idempotency key) 검증

## 5) 주문 생성/저장
- 주문 원본과 상태를 DB에 저장
- 초기 상태 예: `PENDING_NEW` -> `NEW`

## 6) 주문 전송(Broker Core -> Mock Exchange)
- Broker Core가 내부 Mock Exchange Engine으로 주문 전달
- Mock Exchange가 접수/거부/체결 이벤트를 발행

## 7) 체결(핵심)
`체결`은 "주문이 실제 반대 주문과 매칭되어 거래가 성사되는 것"입니다.

- 완전체결: 주문 수량 전체가 거래됨
- 부분체결: 일부 수량만 거래됨(남은 수량은 계속 대기 가능)
- 미체결: 아직 거래가 성사되지 않음

체결 시 발생하는 후처리:
- 체결 내역(trade/fill) 기록
- 잔고/평균매입가/실현손익 업데이트
- 수수료/세금 계산
- 주문 상태 업데이트(`PARTIALLY_FILLED`, `FILLED`)
- 체결 수량/금액만큼 선점분 확정 반영, 미체결 잔량분은 계속 선점 유지
- 재매칭은 시세 갱신 시점에만 수행 (주기 배치 미사용)

## 8) 취소/정정(필요 시)
- 미체결 잔량에 대해 취소/정정 가능
- 부분체결 상태에서 잔량만 취소되는 케이스 존재
- 취소 완료 시 미체결 잔량에 해당하는 선점 자금/수량 해제

## 9) 사후 처리
- 알림 푸시, 히스토리 반영
- 원장(ledger) 반영
- 정산 배치(T+N) 연계
